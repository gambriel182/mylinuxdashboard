{% extends "base.html" %}

{% block title %}Editar Nota - Linux Rice Dashboard{% endblock %}

{% block content %}
<div class="edit-note-container">
    <div class="page-header">
        <h1><span class="icon">‚úèÔ∏è</span> Editar Nota</h1>
        <a href="{{ url_for('notes') }}" class="btn btn-secondary">‚Üê Voltar</a>
    </div>

    <div class="edit-form-card">
        <form method="POST" class="edit-note-form">
            <div class="form-group">
                <label for="title">T√≠tulo:</label>
                <input type="text" id="title" name="title" value="{{ note.title }}" required placeholder="Digite o t√≠tulo da nota">
            </div>
            
            <div class="form-group">
                <label for="content">Conte√∫do:</label>
                <textarea id="content" name="content" rows="8" required placeholder="Digite o conte√∫do da nota">{{ note.content }}</textarea>
            </div>
            
            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" name="completed" {% if note.completed %}checked{% endif %}>
                    <span class="checkmark"></span>
                    Marcar como conclu√≠da
                </label>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">üíæ Salvar Altera√ß√µes</button>
                <a href="{{ url_for('notes') }}" class="btn btn-secondary">Cancelar</a>
                <a href="{{ url_for('delete_note', note_id=note.id) }}" class="btn btn-danger" onclick="return confirm('Tem certeza que deseja apagar esta nota?')">üóëÔ∏è Apagar</a>
            </div>
        </form>
        
        <div class="note-info">
            <div class="info-item">
                <span class="info-label">Criada em:</span>
                <span class="info-value">{{ note.created_at.strftime('%d/%m/%Y %H:%M:%S') }}</span>
            </div>
            {% if note.updated_at != note.created_at %}
            <div class="info-item">
                <span class="info-label">Atualizada em:</span>
                <span class="info-value">{{ note.updated_at.strftime('%d/%m/%Y %H:%M:%S') }}</span>
            </div>
            {% endif %}
            <div class="info-item">
                <span class="info-label">Status:</span>
                <span class="info-value {% if note.completed %}completed{% else %}pending{% endif %}">
                    {% if note.completed %}‚úì Conclu√≠da{% else %}‚è≥ Pendente{% endif %}
                </span>
            </div>
        </div>
    </div>
</div>

<script>
    // Auto-save functionality
    let autoSaveTimeout;
    const originalTitle = document.getElementById('title').value;
    const originalContent = document.getElementById('content').value;
    let hasUnsavedChanges = false;

    function checkForChanges() {
        const currentTitle = document.getElementById('title').value;
        const currentContent = document.getElementById('content').value;
        hasUnsavedChanges = currentTitle !== originalTitle || currentContent !== originalContent;
        
        // Update page title to indicate unsaved changes
        const titleElement = document.querySelector('title');
        if (hasUnsavedChanges && !titleElement.textContent.startsWith('*')) {
            titleElement.textContent = '* ' + titleElement.textContent;
        } else if (!hasUnsavedChanges && titleElement.textContent.startsWith('*')) {
            titleElement.textContent = titleElement.textContent.substring(2);
        }
    }

    function autoSave() {
        if (hasUnsavedChanges) {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const completed = document.querySelector('input[name="completed"]').checked;
            
            // Save to localStorage as backup
            localStorage.setItem('autosave_note_{{ note.id }}', JSON.stringify({
                title, content, completed, timestamp: Date.now()
            }));
            
            console.log('Auto-saved draft');
        }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
        const titleInput = document.getElementById('title');
        const contentInput = document.getElementById('content');
        
        titleInput.addEventListener('input', () => {
            clearTimeout(autoSaveTimeout);
            checkForChanges();
            autoSaveTimeout = setTimeout(autoSave, 2000);
        });
        
        contentInput.addEventListener('input', () => {
            clearTimeout(autoSaveTimeout);
            checkForChanges();
            autoSaveTimeout = setTimeout(autoSave, 2000);
        });
        
        // Check for auto-saved draft
        const savedDraft = localStorage.getItem('autosave_note_{{ note.id }}');
        if (savedDraft) {
            const draft = JSON.parse(savedDraft);
            const timeDiff = Date.now() - draft.timestamp;
            const hoursAgo = timeDiff / (1000 * 60 * 60);
            
            if (hoursAgo < 24 && confirm('Found auto-saved draft from ' + new Date(draft.timestamp).toLocaleString() + '. Load it?')) {
                titleInput.value = draft.title;
                contentInput.value = draft.content;
                document.querySelector('input[name="completed"]').checked = draft.completed;
                checkForChanges();
            } else {
                localStorage.removeItem('autosave_note_{{ note.id }}');
            }
        }
        
        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + S to save
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            document.querySelector('.edit-note-form').submit();
        }
        // Escape to go back
        if (e.key === 'Escape') {
            if (hasUnsavedChanges) {
                if (confirm('You have unsaved changes. Are you sure you want to leave?')) {
                    window.location.href = '{{ url_for("notes") }}';
                }
            } else {
                window.location.href = '{{ url_for("notes") }}';
            }
        }
    });

    // Character counter
    function updateCharCount() {
        const content = document.getElementById('content');
        const charCount = content.value.length;
        const wordCount = content.value.trim().split(/\s+/).filter(word => word.length > 0).length;
        
        // Update counter display (you can add this to the template)
        const counterElement = document.getElementById('char-counter');
        if (counterElement) {
            counterElement.textContent = `${charCount} chars, ${wordCount} words`;
        }
    }

    document.getElementById('content').addEventListener('input', updateCharCount);
</script>

<style>
.edit-note-container {
    max-width: 800px;
    margin: 0 auto;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.page-header h1 {
    color: #00ff41;
    font-size: 2rem;
    margin: 0;
}

.edit-form-card {
    background: rgba(0, 255, 65, 0.05);
    border: 1px solid #00ff41;
    border-radius: 8px;
    padding: 2rem;
}

.edit-note-form {
    margin-bottom: 2rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    color: #00ff41;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.form-group input[type="text"],
.form-group textarea {
    width: 100%;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid #00ff41;
    border-radius: 4px;
    padding: 0.75rem;
    color: #fff;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.form-group input[type="text"]:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #00cc33;
    box-shadow: 0 0 0 2px rgba(0, 255, 65, 0.2);
}

.checkbox-group {
    display: flex;
    align-items: center;
}

.checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    color: #ccc;
    font-weight: normal;
}

.checkbox-label input[type="checkbox"] {
    margin-right: 0.5rem;
    width: auto;
}

.form-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.note-info {
    padding-top: 1.5rem;
    border-top: 1px solid rgba(0, 255, 65, 0.2);
}

.info-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.info-label {
    color: #888;
}

.info-value {
    color: #ccc;
}

.info-value.completed {
    color: #00ff41;
}

.info-value.pending {
    color: #ff9500;
}

@media (max-width: 768px) {
    .page-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .info-item {
        flex-direction: column;
        gap: 0.25rem;
    }
}
</style>
